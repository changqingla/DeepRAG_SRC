# deeprag简化向量存储 - 快速开始


## 🚀 第一步：部署Elasticsearch

### 方法1：Docker快速部署（推荐）
```bash
# 创建并启动ES容器
docker run -d \
  --name deeprag-es \
  -p 9201:9200 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  -e "ES_JAVA_OPTS=-Xms1g -Xmx1g" \
  crpi-wh1i56a4x558rrhm.cn-hangzhou.personal.cr.aliyuncs.com/changqinga/elasticsearch:8.11.3

# 验证ES运行
curl http://localhost:9201
```

### 方法2：使用docker-compose
```bash
# 创建docker-compose.yml（参考deploy_elasticsearch.md）
docker-compose up -d
```

## 🔧 第二步：准备向量数据

确保你有通过embedding模块生成的向量文件：
```bash
# 应该存在这个文件
ls ../embedding/embedded_chunks.json
```

文件格式示例：
```json
[
  {
    "docnm_kwd": "文档.pdf",
    "content_with_weight": "分块内容",
    "q_1024_vec": [0.1, 0.2, ...],  // 1024维向量
    "title_tks": "标题"
  }
]
```

## ⚡ 第三步：快速存储

### 最简单的方式
```bash
# 使用默认配置存储
python simple_store.py ../embedding/embedded_chunks.json
```

### 自定义索引名称
```bash
# 指定索引名称
python simple_store.py ../embedding/embedded_chunks.json --index my_vectors
```

### 自定义ES地址
```bash
# 如果ES不在localhost
python simple_store.py markdown_chunks_embedded.json \
  --es-host http://10.0.100.36:9201 \
  --index my_vectors
```

## 📝 第四步：验证存储

### 检查ES中的数据
```bash
# 查看索引
curl http://localhost:9200/_cat/indices

# 查看索引mapping
curl http://localhost:9200/deeprag_vectors/_mapping

# 搜索数据
curl -X GET "http://localhost:9200/deeprag_vectors/_search?pretty" \
  -H 'Content-Type: application/json' \
  -d '{"query": {"match_all": {}}, "size": 1}'
```

### 使用工具验证
```bash
# 仅验证数据格式
python simple_store.py ../embedding/embedded_chunks.json --validate-only

# 显示索引信息
python simple_store.py ../embedding/embedded_chunks.json --show-info
```

## 💻 编程方式使用

### 基本使用
```python
from chunk_store import SimpleVectorStore, SimpleStoreConfig

# 创建配置
config = SimpleStoreConfig.create_simple("my_vectors")

# 创建存储器
store = SimpleVectorStore(config)

# 存储向量（chunks是向量数据列表）
stored_count, errors = store.store_vectors(chunks)

print(f"存储了 {stored_count} 个向量")
```

### 自定义ES配置
```python
# 自定义ES地址
config = SimpleStoreConfig(
    index_name="my_vectors",
    es_config={
        "hosts": "http://192.168.1.100:9200",
        "timeout": 600
    },
    batch_size=16
)

store = SimpleVectorStore(config)
```

## 🔍 常见问题

### 1. ES连接失败
```
❌ ES连接失败: ConnectionError
```
**解决方案**:
- 检查ES是否运行: `curl http://localhost:9200`
- 检查端口是否正确
- 检查防火墙设置

### 2. 向量字段错误
```
❌ 未找到向量字段
```
**解决方案**:
- 确保数据包含 `q_*_vec` 格式的向量字段
- 检查向量是否为数字列表
- 使用 `--validate-only` 验证数据

### 3. 索引创建失败
```
❌ 创建索引失败
```
**解决方案**:
- 检查ES版本（需要8.0+）
- 检查ES磁盘空间
- 查看ES日志

## 📊 性能优化

### 调整批量大小
```bash
# 大批量（适合高性能机器）
python simple_store.py data.json --batch-size 32

# 小批量（适合低配置机器）
python simple_store.py data.json --batch-size 4
```

### ES配置优化
```python
# 高性能配置
es_config = {
    "hosts": "http://localhost:9200",
    "timeout": 1200,  # 增加超时时间
}
```

## 🎉 完成！

现在你已经成功：
1. ✅ 部署了本地Elasticsearch
2. ✅ 将向量数据存储到ES中
3. ✅ 保持了deeprag的存储算法
4. ✅ 简化了租户和知识库层级

## 🔄 与原有系统的区别

| 特性 | 原deeprag | 简化版本 |
|------|-----------|----------|
| 租户系统 | ✅ 需要 | ❌ 不需要 |
| 知识库层级 | ✅ 需要 | ❌ 不需要 |
| 存储算法 | ✅ 完整 | ✅ 完整 |
| 向量索引 | ✅ 支持 | ✅ 支持 |
| 批量插入 | ✅ 支持 | ✅ 支持 |
| 错误处理 | ✅ 完整 | ✅ 完整 |

## 📚 更多示例

查看以下文件获取更多使用示例：
- `simple_example.py` - 编程示例
- `deploy_elasticsearch.md` - ES部署详情
- `README.md` - 完整文档
