# deepragç®€åŒ–å‘é‡å­˜å‚¨ - å¿«é€Ÿå¼€å§‹


## ğŸš€ ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½²Elasticsearch

### æ–¹æ³•1ï¼šDockerå¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰
```bash
# åˆ›å»ºå¹¶å¯åŠ¨ESå®¹å™¨
docker run -d \
  --name deeprag-es \
  -p 9201:9200 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  -e "ES_JAVA_OPTS=-Xms1g -Xmx1g" \
  crpi-wh1i56a4x558rrhm.cn-hangzhou.personal.cr.aliyuncs.com/changqinga/elasticsearch:8.11.3

# éªŒè¯ESè¿è¡Œ
curl http://localhost:9201
```

### æ–¹æ³•2ï¼šä½¿ç”¨docker-compose
```bash
# åˆ›å»ºdocker-compose.ymlï¼ˆå‚è€ƒdeploy_elasticsearch.mdï¼‰
docker-compose up -d
```

## ğŸ”§ ç¬¬äºŒæ­¥ï¼šå‡†å¤‡å‘é‡æ•°æ®

ç¡®ä¿ä½ æœ‰é€šè¿‡embeddingæ¨¡å—ç”Ÿæˆçš„å‘é‡æ–‡ä»¶ï¼š
```bash
# åº”è¯¥å­˜åœ¨è¿™ä¸ªæ–‡ä»¶
ls ../embedding/embedded_chunks.json
```

æ–‡ä»¶æ ¼å¼ç¤ºä¾‹ï¼š
```json
[
  {
    "docnm_kwd": "æ–‡æ¡£.pdf",
    "content_with_weight": "åˆ†å—å†…å®¹",
    "q_1024_vec": [0.1, 0.2, ...],  // 1024ç»´å‘é‡
    "title_tks": "æ ‡é¢˜"
  }
]
```

## âš¡ ç¬¬ä¸‰æ­¥ï¼šå¿«é€Ÿå­˜å‚¨

### æœ€ç®€å•çš„æ–¹å¼
```bash
# ä½¿ç”¨é»˜è®¤é…ç½®å­˜å‚¨
python simple_store.py ../embedding/embedded_chunks.json
```

### è‡ªå®šä¹‰ç´¢å¼•åç§°
```bash
# æŒ‡å®šç´¢å¼•åç§°
python simple_store.py ../embedding/embedded_chunks.json --index my_vectors
```

### è‡ªå®šä¹‰ESåœ°å€
```bash
# å¦‚æœESä¸åœ¨localhost
python simple_store.py markdown_chunks_embedded.json \
  --es-host http://10.0.100.36:9201 \
  --index my_vectors
```

## ğŸ“ ç¬¬å››æ­¥ï¼šéªŒè¯å­˜å‚¨

### æ£€æŸ¥ESä¸­çš„æ•°æ®
```bash
# æŸ¥çœ‹ç´¢å¼•
curl http://localhost:9200/_cat/indices

# æŸ¥çœ‹ç´¢å¼•mapping
curl http://localhost:9200/deeprag_vectors/_mapping

# æœç´¢æ•°æ®
curl -X GET "http://localhost:9200/deeprag_vectors/_search?pretty" \
  -H 'Content-Type: application/json' \
  -d '{"query": {"match_all": {}}, "size": 1}'
```

### ä½¿ç”¨å·¥å…·éªŒè¯
```bash
# ä»…éªŒè¯æ•°æ®æ ¼å¼
python simple_store.py ../embedding/embedded_chunks.json --validate-only

# æ˜¾ç¤ºç´¢å¼•ä¿¡æ¯
python simple_store.py ../embedding/embedded_chunks.json --show-info
```

## ğŸ’» ç¼–ç¨‹æ–¹å¼ä½¿ç”¨

### åŸºæœ¬ä½¿ç”¨
```python
from chunk_store import SimpleVectorStore, SimpleStoreConfig

# åˆ›å»ºé…ç½®
config = SimpleStoreConfig.create_simple("my_vectors")

# åˆ›å»ºå­˜å‚¨å™¨
store = SimpleVectorStore(config)

# å­˜å‚¨å‘é‡ï¼ˆchunksæ˜¯å‘é‡æ•°æ®åˆ—è¡¨ï¼‰
stored_count, errors = store.store_vectors(chunks)

print(f"å­˜å‚¨äº† {stored_count} ä¸ªå‘é‡")
```

### è‡ªå®šä¹‰ESé…ç½®
```python
# è‡ªå®šä¹‰ESåœ°å€
config = SimpleStoreConfig(
    index_name="my_vectors",
    es_config={
        "hosts": "http://192.168.1.100:9200",
        "timeout": 600
    },
    batch_size=16
)

store = SimpleVectorStore(config)
```

## ğŸ” å¸¸è§é—®é¢˜

### 1. ESè¿æ¥å¤±è´¥
```
âŒ ESè¿æ¥å¤±è´¥: ConnectionError
```
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ESæ˜¯å¦è¿è¡Œ: `curl http://localhost:9200`
- æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### 2. å‘é‡å­—æ®µé”™è¯¯
```
âŒ æœªæ‰¾åˆ°å‘é‡å­—æ®µ
```
**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿æ•°æ®åŒ…å« `q_*_vec` æ ¼å¼çš„å‘é‡å­—æ®µ
- æ£€æŸ¥å‘é‡æ˜¯å¦ä¸ºæ•°å­—åˆ—è¡¨
- ä½¿ç”¨ `--validate-only` éªŒè¯æ•°æ®

### 3. ç´¢å¼•åˆ›å»ºå¤±è´¥
```
âŒ åˆ›å»ºç´¢å¼•å¤±è´¥
```
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ESç‰ˆæœ¬ï¼ˆéœ€è¦8.0+ï¼‰
- æ£€æŸ¥ESç£ç›˜ç©ºé—´
- æŸ¥çœ‹ESæ—¥å¿—

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### è°ƒæ•´æ‰¹é‡å¤§å°
```bash
# å¤§æ‰¹é‡ï¼ˆé€‚åˆé«˜æ€§èƒ½æœºå™¨ï¼‰
python simple_store.py data.json --batch-size 32

# å°æ‰¹é‡ï¼ˆé€‚åˆä½é…ç½®æœºå™¨ï¼‰
python simple_store.py data.json --batch-size 4
```

### ESé…ç½®ä¼˜åŒ–
```python
# é«˜æ€§èƒ½é…ç½®
es_config = {
    "hosts": "http://localhost:9200",
    "timeout": 1200,  # å¢åŠ è¶…æ—¶æ—¶é—´
}
```

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ å·²ç»æˆåŠŸï¼š
1. âœ… éƒ¨ç½²äº†æœ¬åœ°Elasticsearch
2. âœ… å°†å‘é‡æ•°æ®å­˜å‚¨åˆ°ESä¸­
3. âœ… ä¿æŒäº†deepragçš„å­˜å‚¨ç®—æ³•
4. âœ… ç®€åŒ–äº†ç§Ÿæˆ·å’ŒçŸ¥è¯†åº“å±‚çº§

## ğŸ”„ ä¸åŸæœ‰ç³»ç»Ÿçš„åŒºåˆ«

| ç‰¹æ€§ | åŸdeeprag | ç®€åŒ–ç‰ˆæœ¬ |
|------|-----------|----------|
| ç§Ÿæˆ·ç³»ç»Ÿ | âœ… éœ€è¦ | âŒ ä¸éœ€è¦ |
| çŸ¥è¯†åº“å±‚çº§ | âœ… éœ€è¦ | âŒ ä¸éœ€è¦ |
| å­˜å‚¨ç®—æ³• | âœ… å®Œæ•´ | âœ… å®Œæ•´ |
| å‘é‡ç´¢å¼• | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| æ‰¹é‡æ’å…¥ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| é”™è¯¯å¤„ç† | âœ… å®Œæ•´ | âœ… å®Œæ•´ |

## ğŸ“š æ›´å¤šç¤ºä¾‹

æŸ¥çœ‹ä»¥ä¸‹æ–‡ä»¶è·å–æ›´å¤šä½¿ç”¨ç¤ºä¾‹ï¼š
- `simple_example.py` - ç¼–ç¨‹ç¤ºä¾‹
- `deploy_elasticsearch.md` - ESéƒ¨ç½²è¯¦æƒ…
- `README.md` - å®Œæ•´æ–‡æ¡£
